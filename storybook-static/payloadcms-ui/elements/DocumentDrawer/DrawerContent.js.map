{"version":3,"file":"DrawerContent.js","names":["useModal","React","useCallback","useEffect","useRef","useState","toast","LoadingOverlay","useConfig","useLocale","useServerFunctions","useTranslation","abortAndIgnore","handleAbortRef","DocumentDrawerContextProvider","DocumentDrawerContent","id","existingDocID","AfterFields","collectionSlug","disableActions","drawerSlug","Header","initialData","onDelete","onDeleteFromProps","onDuplicate","onDuplicateFromProps","onSave","onSaveFromProps","overrideEntityVisibility","redirectAfterCreate","redirectAfterDelete","redirectAfterDuplicate","getEntityConfig","locale","collectionConfig","abortGetDocumentViewRef","closeModal","t","renderDocument","DocumentView","setDocumentView","undefined","isLoading","setIsLoading","hasRenderedDocument","getDocumentView","docID","controller","fetchDocumentView","result","signal","Document","error","message","current","args","doc","clearDoc","abortGetDocumentView","_jsx"],"sources":["../../../src/elements/DocumentDrawer/DrawerContent.tsx"],"sourcesContent":["'use client'\n\nimport { useModal } from '@faceless-ui/modal'\nimport React, { useCallback, useEffect, useRef, useState } from 'react'\nimport { toast } from 'sonner'\n\nimport type { DocumentDrawerProps } from './types.js'\n\nimport { LoadingOverlay } from '../../elements/Loading/index.js'\nimport { useConfig } from '../../providers/Config/index.js'\nimport { useLocale } from '../../providers/Locale/index.js'\nimport { useServerFunctions } from '../../providers/ServerFunctions/index.js'\nimport { useTranslation } from '../../providers/Translation/index.js'\nimport { abortAndIgnore, handleAbortRef } from '../../utilities/abortAndIgnore.js'\nimport { DocumentDrawerContextProvider } from './Provider.js'\n\nexport const DocumentDrawerContent: React.FC<DocumentDrawerProps> = ({\n  id: existingDocID,\n  AfterFields,\n  collectionSlug,\n  disableActions,\n  drawerSlug,\n  Header,\n  initialData,\n  onDelete: onDeleteFromProps,\n  onDuplicate: onDuplicateFromProps,\n  onSave: onSaveFromProps,\n  overrideEntityVisibility = true,\n  redirectAfterCreate,\n  redirectAfterDelete,\n  redirectAfterDuplicate,\n}) => {\n  const { getEntityConfig } = useConfig()\n  const locale = useLocale()\n\n  const [collectionConfig] = useState(() => getEntityConfig({ collectionSlug }))\n\n  const abortGetDocumentViewRef = React.useRef<AbortController>(null)\n\n  const { closeModal } = useModal()\n  const { t } = useTranslation()\n\n  const { renderDocument } = useServerFunctions()\n\n  const [DocumentView, setDocumentView] = useState<React.ReactNode>(undefined)\n  const [isLoading, setIsLoading] = useState(true)\n  const hasRenderedDocument = useRef(false)\n\n  const getDocumentView = useCallback(\n    (docID?: number | string) => {\n      const controller = handleAbortRef(abortGetDocumentViewRef)\n\n      const fetchDocumentView = async () => {\n        setIsLoading(true)\n\n        try {\n          const result = await renderDocument({\n            collectionSlug,\n            disableActions,\n            docID,\n            drawerSlug,\n            initialData,\n            locale,\n            overrideEntityVisibility,\n            redirectAfterCreate,\n            redirectAfterDelete: redirectAfterDelete !== undefined ? redirectAfterDelete : false,\n            redirectAfterDuplicate:\n              redirectAfterDuplicate !== undefined ? redirectAfterDuplicate : false,\n            signal: controller.signal,\n          })\n\n          if (result?.Document) {\n            setDocumentView(result.Document)\n            setIsLoading(false)\n          }\n        } catch (error) {\n          toast.error(error?.message || t('error:unspecific'))\n          closeModal(drawerSlug)\n          // toast.error(data?.errors?.[0].message || t('error:unspecific'))\n        }\n\n        abortGetDocumentViewRef.current = null\n      }\n\n      void fetchDocumentView()\n    },\n    [\n      collectionSlug,\n      disableActions,\n      drawerSlug,\n      initialData,\n      redirectAfterDelete,\n      redirectAfterDuplicate,\n      renderDocument,\n      closeModal,\n      overrideEntityVisibility,\n      t,\n      locale,\n    ],\n  )\n\n  const onSave = useCallback<DocumentDrawerProps['onSave']>(\n    (args) => {\n      getDocumentView(args.doc.id)\n\n      if (typeof onSaveFromProps === 'function') {\n        void onSaveFromProps({\n          ...args,\n          collectionConfig,\n        })\n      }\n    },\n    [onSaveFromProps, collectionConfig, getDocumentView],\n  )\n\n  const onDuplicate = useCallback<DocumentDrawerProps['onDuplicate']>(\n    (args) => {\n      getDocumentView(args.doc.id)\n\n      if (typeof onDuplicateFromProps === 'function') {\n        void onDuplicateFromProps({\n          ...args,\n          collectionConfig,\n        })\n      }\n    },\n    [onDuplicateFromProps, collectionConfig, getDocumentView],\n  )\n\n  const onDelete = useCallback<DocumentDrawerProps['onDelete']>(\n    (args) => {\n      if (typeof onDeleteFromProps === 'function') {\n        void onDeleteFromProps({\n          ...args,\n          collectionConfig,\n        })\n      }\n\n      closeModal(drawerSlug)\n    },\n    [onDeleteFromProps, closeModal, drawerSlug, collectionConfig],\n  )\n\n  const clearDoc = useCallback(() => {\n    getDocumentView()\n  }, [getDocumentView])\n\n  useEffect(() => {\n    if (!DocumentView && !hasRenderedDocument.current) {\n      getDocumentView(existingDocID)\n      hasRenderedDocument.current = true\n    }\n  }, [DocumentView, getDocumentView, existingDocID])\n\n  // Cleanup any pending requests when the component unmounts\n  useEffect(() => {\n    const abortGetDocumentView = abortGetDocumentViewRef.current\n\n    return () => {\n      abortAndIgnore(abortGetDocumentView)\n    }\n  }, [])\n\n  if (isLoading) {\n    return <LoadingOverlay />\n  }\n\n  return (\n    <DocumentDrawerContextProvider\n      clearDoc={clearDoc}\n      drawerSlug={drawerSlug}\n      onDelete={onDelete}\n      onDuplicate={onDuplicate}\n      onSave={onSave}\n    >\n      {DocumentView}\n    </DocumentDrawerContextProvider>\n  )\n}\n"],"mappings":"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","ignoreList":[]}