{"version":3,"file":"index.js","names":["useModal","getTranslation","useRouter","useSearchParams","qs","React","useCallback","toast","useAuth","useConfig","useRouteCache","SelectAllStatus","useSelection","useTranslation","requests","parseSearchParams","ConfirmationModal","baseClass","UnpublishMany","props","collection","slug","labels","plural","singular","versions","config","routes","api","serverURL","permissions","toggleModal","i18n","t","searchParams","getQueryParams","selectAll","router","clearRouteCache","collectionPermissions","collections","hasPermission","update","modalSlug","addDefaultError","error","handleUnpublish","patch","_status","not_equals","body","JSON","stringify","headers","language","then","res","json","deletedDocs","docs","length","successLabel","status","success","count","label","errors","message","description","map","join","replace","page","undefined","addQueryPrefix","forEach","_err","drafts","None","_jsxs","Fragment","_jsx","className","onClick","type","confirmingLabel","heading","onConfirm"],"sources":["../../../src/elements/UnpublishMany/index.tsx"],"sourcesContent":["'use client'\nimport type { ClientCollectionConfig } from 'payload'\n\nimport { useModal } from '@faceless-ui/modal'\nimport { getTranslation } from '@payloadcms/translations'\nimport { useRouter, useSearchParams } from 'next/navigation.js'\nimport * as qs from 'qs-esm'\nimport React, { useCallback } from 'react'\nimport { toast } from 'sonner'\n\nimport { useAuth } from '../../providers/Auth/index.js'\nimport { useConfig } from '../../providers/Config/index.js'\nimport { useRouteCache } from '../../providers/RouteCache/index.js'\nimport { SelectAllStatus, useSelection } from '../../providers/Selection/index.js'\nimport { useTranslation } from '../../providers/Translation/index.js'\nimport { requests } from '../../utilities/api.js'\nimport { parseSearchParams } from '../../utilities/parseSearchParams.js'\nimport { ConfirmationModal } from '../ConfirmationModal/index.js'\nimport './index.scss'\n\nexport type UnpublishManyProps = {\n  collection: ClientCollectionConfig\n}\n\nconst baseClass = 'unpublish-many'\n\nexport const UnpublishMany: React.FC<UnpublishManyProps> = (props) => {\n  const { collection: { slug, labels: { plural, singular }, versions } = {} } = props\n\n  const {\n    config: {\n      routes: { api },\n      serverURL,\n    },\n  } = useConfig()\n\n  const { permissions } = useAuth()\n  const { toggleModal } = useModal()\n  const { i18n, t } = useTranslation()\n  const searchParams = useSearchParams()\n  const { getQueryParams, selectAll } = useSelection()\n  const router = useRouter()\n  const { clearRouteCache } = useRouteCache()\n\n  const collectionPermissions = permissions?.collections?.[slug]\n  const hasPermission = collectionPermissions?.update\n\n  const modalSlug = `unpublish-${slug}`\n\n  const addDefaultError = useCallback(() => {\n    toast.error(t('error:unknown'))\n  }, [t])\n\n  const handleUnpublish = useCallback(async () => {\n    await requests\n      .patch(`${serverURL}${api}/${slug}${getQueryParams({ _status: { not_equals: 'draft' } })}`, {\n        body: JSON.stringify({\n          _status: 'draft',\n        }),\n        headers: {\n          'Accept-Language': i18n.language,\n          'Content-Type': 'application/json',\n        },\n      })\n      .then(async (res) => {\n        try {\n          const json = await res.json()\n\n          const deletedDocs = json?.docs.length || 0\n          const successLabel = deletedDocs > 1 ? plural : singular\n\n          if (res.status < 400 || deletedDocs > 0) {\n            toast.success(\n              t('general:updatedCountSuccessfully', {\n                count: deletedDocs,\n                label: getTranslation(successLabel, i18n),\n              }),\n            )\n\n            if (json?.errors.length > 0) {\n              toast.error(json.message, {\n                description: json.errors.map((error) => error.message).join('\\n'),\n              })\n            }\n\n            router.replace(\n              qs.stringify(\n                {\n                  ...parseSearchParams(searchParams),\n                  page: selectAll ? '1' : undefined,\n                },\n                { addQueryPrefix: true },\n              ),\n            )\n\n            clearRouteCache() // Use clearRouteCache instead of router.refresh, as we only need to clear the cache if the user has route caching enabled - clearRouteCache checks for this\n\n            return null\n          }\n\n          if (json.errors) {\n            json.errors.forEach((error) => toast.error(error.message))\n          } else {\n            addDefaultError()\n          }\n          return false\n        } catch (_err) {\n          return addDefaultError()\n        }\n      })\n  }, [\n    serverURL,\n    api,\n    slug,\n    getQueryParams,\n    i18n,\n    plural,\n    singular,\n    t,\n    router,\n    searchParams,\n    selectAll,\n    clearRouteCache,\n    addDefaultError,\n  ])\n\n  if (!versions?.drafts || selectAll === SelectAllStatus.None || !hasPermission) {\n    return null\n  }\n\n  return (\n    <React.Fragment>\n      <button\n        className={`${baseClass}__toggle`}\n        onClick={() => {\n          toggleModal(modalSlug)\n        }}\n        type=\"button\"\n      >\n        {t('version:unpublish')}\n      </button>\n      <ConfirmationModal\n        body={t('version:aboutToUnpublishSelection', { label: getTranslation(plural, i18n) })}\n        confirmingLabel={t('version:unpublishing')}\n        heading={t('version:confirmUnpublish')}\n        modalSlug={modalSlug}\n        onConfirm={handleUnpublish}\n      />\n    </React.Fragment>\n  )\n}\n"],"mappings":"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","ignoreList":[]}